<!DOCTYPE html>
<html lang="ko">
<head>
    <title>LeePerrySmith</title>
    <meta charset="utf-8"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no,target-densitydpi=high-dpi "/>
    <style>
        body {
            background-color: #000;
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100%;
        }

        .FPS {
            color: #FFF;
            left: 0px;
            top: 0px;
            position: absolute
        }
    </style>
    <script src="../src/MoGL.js"></script>
    <script src="../src/BlendMode.js"></script>
    <script src="../src/Filter.js"></script>
    <script src="../src/Vertex.js"></script>
    <script src="../src/Shading.js"></script>
    <script src="../src/VertexShaderFunctions.js"></script>
    <script src="../src/Shader.js"></script>
    <script src="../src/Matrix.js"></script>
    <script src="../src/Geometry.js"></script>
    <script src="../src/Material.js"></script>
    <script src="../src/Texture.js"></script>
    <script src="../src/Mesh.js"></script>
    <script src="../src/Group.js"></script>
    <script src="../src/Camera.js"></script>
    <script src="../src/Scene.js"></script>
    <script src="../src/World.js"></script>
</head>
<body>
<canvas id="canvas"></canvas>

<div class="FPS">
    Current FPS: <span id="currentFPS"></span>
    Average FPS: <span id="averageFPS"></span>
</div>
<img src="smithHead/Map-COL.jpg" id="testIMG" style="position: absolute;top:0px;" width="128" height="128">
<img src="monkey/Suzanne.jpg" id="testIMG2" style="position: absolute;top:0px;" width="128" height="128">
<script>
    'use strict';
    var world = new World('canvas');
    var scene = new Scene();
    var camera = new Camera()
    var material = new Material('#fff')
    var material2 = new Material('#22f232')
    var material3 = new Material('#fef232')
    scene.addChild(camera);
    world.addScene(scene);
    world.setAutoSize(1)



    var texture = new Texture()

    //    scene.addTexture('texture', 'smithHead/Map-COL.jpg');
    //    scene.getMaterial('material').addTexture(Texture.diffuse, 'texture');
    //    scene.getMaterial('material2').addTexture(Texture.diffuse, 'texture');
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.open('GET', 'smithHead/smith_head.json', true);
    xmlhttp.onreadystatechange = function () {
        if (xmlhttp.readyState === 4 && xmlhttp.status === 200) {
            start(JSON.parse(xmlhttp.responseText));
        }
    };
    xmlhttp.send(null);
    function start(json) {
        var vertices = json.vertices, faces = json.faces, uvs = json.uv;

        var vertexBuffer = [], indexBuffer = [], uvArray = [], i, j, fv = 0, uvSize = uvs.length;

        faces.forEach(function (v) {
            v.forEach(function (vv) {
                if (fv < uvSize)
                    uvArray[vv] = uvs[fv];
                fv++;
            })
        });
        for (i = 0, j = vertices.length; i < j; i++) {
            vertexBuffer.push(vertices[i][0], vertices[i][1], vertices[i][2], uvArray[i][0], 1.0 - uvArray[i][1]);
        }
        for (i = 0, j = faces.length; i < j; i++) {
            indexBuffer.push(faces[i][0], faces[i][1], faces[i][2]);
            indexBuffer.push(faces[i][0], faces[i][2], faces[i][3]);
        }
        var geo = new Geometry(vertexBuffer, indexBuffer, [Vertex.x, Vertex.y, Vertex.z, Vertex.u, Vertex.v])
        scene.addGeometry(geo);
        var mesh = new Mesh(geo, material);
        mesh.scaleX = 10;
        mesh.scaleY = 10;
        mesh.scaleZ = 10;
        scene.addChild(mesh);

        material.wireFrame = 1
        material2.wireFrame = 1
        material3.wireFrame = 1
//
        var mesh2 = new Mesh(geo, material2);
        mesh2.scaleX = 10;
        mesh2.scaleY = 10;
        mesh2.scaleZ = 10;
        scene.addChild(mesh2);

        mesh.x = -3
        mesh2.x = 3

        var mesh3 = new Mesh(geo, material3);
        mesh3.scaleX = 10;
        mesh3.scaleY = 10;
        mesh3.scaleZ = 10;
        scene.addChild(mesh3);

        material2.shading = Shading.phong
        material3.shading = Shading.phong
        material3.lambert = 1.5

        mesh3.y = -1
        material.shading = Shading.phong

        texture.img = document.getElementById('testIMG')
        material.addTexture(Texture.diffuse, texture)
        console.log('재질 텍스쳐 로딩완료 확인',material.isLoaded)
        console.log('디퓨즈 확인',material.diffuse)

        setTimeout(function(){
            var texture2 = new Texture()
            texture2.img = document.getElementById('testIMG2')
            material.addTexture(Texture.diffuse, texture2)
        },1000)

        world.addEventListener(World.renderBefore, function () {
            mesh.rotateY -= 0.01;
            mesh2.rotateY -= 0.01;
            mesh3.rotateY -= 0.01;
        })
        world.start()
    }

</script>
</body>
</html>